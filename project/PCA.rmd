---
title: "Principal Components and Partial Least Squares analysis in data with different correlation structure."
subtitle: "Computational Statistics, University of Bonn 2022"
author: "Krasimira Kirilova"
date: "August 23, 2022"
output: 
  pdf_document:
    toc: true
    number_sections: true
fontsize: "11pt"
geometry: "margin=1in"
urlcolor: "blue"
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

# Introduction
Economic phenomena, both micro and macro, has always been influenced by a large number of variables. Difficulties in data collection and lack of computational power in the past imposed usage of small structural models for forecasting. Nowadays we can employ several techniques and methods to forecast economic variables using high-dimensional data. Principal component analysis(PCA) is a wildly common method for dimension reduction. The basic idea is to transform the original data in such way as to use smaller number of factors in our prediction instead of the original number of variables. Partial Least Squares(PLS) constructs the factors such that the covariance between the factors and the target variable is maximized. My goal with this project is to explore the kinds of data structure where PCA performs poorly. In the literature one of the cases studied is high-dimensional data where one variable is highly important for the target variable and the other variables are not. The many noisy variables tend to  mask the signal in the leading variable when constructing the factors, leading to worse prediction.
The project is organized into Theoretical background section and simulation and empirical application sections. For the lather sections I take guidance from [J. Groen, G. Kapetanios 2008](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=1136165) and use data set from [Stock and Watson (2009)](https://scholar.harvard.edu/stock/publications/forecasting-dynamic-factor-models-subject-structural-instability).

# Theorethical background of PCA and PLS


```{r eval = FALSE, echo = FALSE, message = FALSE, warning=FALSE}
library("pls") # PCA and PLS regression
library("readxl") # read Excel files
library("MASS")
library("esquisse") # addin for data visualization
library("xts") #time series conversion
library("zoo") # time series
```
# Simulation
```{r, eval = FALSE, echo = FALSE, message = FALSE, warning=FALSE}
source("functions/constants.R")
source("functions/data_utils.R")
source("functions/helpers.R")
source("functions/generate_data.R")
source("functions/run_simulation.R")

# Simulation 1: N = 100, p = 20, runs = 100, use optimal component number ----
simulation_option_default <- list(N = possible_N[1],
                                  p = 20,
                                  runs = 100)
dgp_option_default <- list(BETAS_INCREASE_FACTOR = 4)

simulation1 <- new.env()

simulation1$result <-
  simulation(dgp_option_list = dgp_option_default,
             simulation_option_list = simulation_option_default)
# Compute mean statistics from simulation
simulation1$MSE_stats <-
  save_mean_mse_and_return_stats(simulation1$result)

pdf(file = "images/simulation_1/simulation1.pdf")
par(mfrow = c(3, 2))
plot_MSE_comparison_boxplot(simulation1$result, simulation1$MSE_stats)
dev.off()

# Simulation 2: N = 200, p = 20, use optimal number of components ----
simulation2 <- new.env()

simulation2$sim_option <- simulation_option_default
simulation2$sim_option$N <- possible_N[2]

simulation2$result <-
  simulation(dgp_option_list = dgp_option_default,
             simulation_option_list = simulation2$sim_option)

simulation2$MSE_stats <-
  save_mean_mse_and_return_stats(simulation2$result)

pdf(file = "images/simulation_1/simulation2.pdf")
par(mfrow = c(3, 2))
plot_MSE_comparison_boxplot(simulation2$result, simulation2$MSE_stats)
dev.off()

# Simulation 3: N = 400, p = 20, use optimal number of components ----
simulation3 <- new.env()

simulation3$sim_option <- simulation_option_default
simulation3$sim_option$N <- possible_N[3] # 400

simulation3$result <-
  simulation(dgp_option_list = dgp_option_default,
             simulation_option_list = simulation3$sim_option)

simulation3$MSE_stats <-
  save_mean_mse_and_return_stats(simulation3$result)

pdf(file = "images/simulation_1/simulation3.pdf")
par(mfrow = c(3, 2))
plot_MSE_comparison_boxplot(simulation3$result, simulation3$MSE_stats)
dev.off()

# Simulation 4: N = 200, p = 100, use optimal number of components ----
simulation4 <- new.env()

simulation4$sim_option <- simulation_option_default
simulation4$sim_option$N <- possible_N[2] # 200
simulation4$sim_option$p <- 100

simulation4$result <-
  simulation(dgp_option_list = dgp_option_default,
             simulation_option_list = simulation4$sim_option)

simulation4$MSE_stats <-
  save_mean_mse_and_return_stats(simulation4$result)

pdf(file = "images/simulation_1/simulation4.pdf")
par(mfrow = c(3, 2))
plot_MSE_comparison_boxplot(simulation4$result, simulation4$MSE_stats)
dev.off()

# Simulation 5: N = 200, p = 100, ncomp = 6 ----
simulation5 <- new.env()

simulation5$sim_option <- simulation_option_default
simulation5$sim_option$N <- possible_N[2] # 200
simulation5$sim_option$p <- 100
simulation5$sim_option$ncomp <- 6

simulation5$result <-
  simulation(dgp_option_list = dgp_option_default,
             simulation_option_list = simulation5$sim_option)

simulation5$MSE_stats <-
  save_mean_mse_and_return_stats(simulation5$result)

pdf(file = "images/simulation_1/simulation5.pdf")
par(mfrow = c(3, 2))
plot_MSE_comparison_boxplot(simulation5$result , simulation5$MSE_stats)
dev.off()

```

![Simulation 1](images/simulation_1/simulation1.pdf){width=65%}  


# Empirical Applicaiton
```{r, results='hide', echo=FALSE, eval = FALSE, message=FALSE}
# Load Data set
load(file = "../data/data/WORKING_DATA.rda")

# CONSTANTS ----

# Variables to forecast:
# CPI inflation
# (aggregate) industrial production, 
# (aggregate) unemployment rate
# (effective) federal funds rate
predictor_variables <- c("CPIAUCSL", "IPS10", "LHUR", "FYFF")

# END CONSTANTS ----

# Get data set end date(Note: this could be a constant, but again if you change the file now including later years this code will work automatically)
data_end_date <- tail(zoo::as.Date(WORKING_DATA$rawdata), n = 1)
transformed_ts <- get_transformed_time_series(WORKING_DATA, enddate = data_end_date)

ts_cor <- cor(WORKING_DATA$rawdata)
# Try do to PCA on the whole dataset, all components
set.seed(2)
# prediction_var <- transformed_ts[, predictor_variables]
# transformed_ts <- remove_columns(transformed_ts, predictor_variables)
# result <- pcr(prediction_var ~ ., data = transformed_ts, scale = TRUE, validaiton = CV)
# summary(result)
# validationplot(result, val.type = "MSEP")

IPS10_pca <- pcr(IPS10 ~ ., data = transformed_ts, scale = TRUE, validation = "CV", ncomp = 5)

# summary(IPS10_pca)
# plot(
#   IPS10_pca$scores[, 4], 
#   transformed_ts[, "IPS10"][1:190],
#   xlab = "PC comp 4 scores",
#   ylab = "IPS10")
# plot(
#   IPS10_pca$scores[, 2], 
#   transformed_ts[, "IPS10"][1:190],
#   xlab = "PC comp 2 scores",
#   ylab = "IPS10")
# biplot(IPS10_pca, which = "loadings")
# # Shows cross-validated error
# plot(RMSEP(IPS10_pca), legendpos = "topright")
# # Shows cross-validated predictions vs measured
# plot(IPS10_pca, ncomp = 2, asp = 1, line = TRUE)
# 
# plot(IPS10_pca, "loadings", comps = 1:3, legendpos = "topleft", xlab = "nm")
# abline(h = 0)

```